<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Demonstration of SHyFT API implementation of Kalman Filtering on gridded data &#8212; Shyft 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="Shyft 0.1 documentation" href="../../index.html" />
    <link rel="up" title="Notebooks" href="../../notebook.html" />
    <link rel="next" title="Demonstration of SHyFT API implementation of Kalman Filtering on time series" href="gridpp_simple.html" />
    <link rel="prev" title="Running a calibration with SHyFT" href="../nea-example/calibrate_nea_nidelva.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="gridpp_simple.html" title="Demonstration of SHyFT API implementation of Kalman Filtering on time series"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../nea-example/calibrate_nea_nidelva.html" title="Running a calibration with SHyFT"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Shyft 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../introduction.html" >What&#8217;s SHyFT?</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../notebook.html" accesskey="U">Notebooks</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput > div,
div.nbinput div[class^=highlight],
div.nbinput div[class^=highlight] pre,
div.nboutput,
div.nboutput > div,
div.nboutput div[class^=highlight],
div.nboutput div[class^=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class^=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput > :first-child pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput > :first-child pre {
    color: #D84315;
}

/* all prompts */
div.nbinput > :first-child[class^=highlight],
div.nboutput > :first-child[class^=highlight],
div.nboutput > :first-child {
    min-width: 8ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}

/* input/output area */
div.nbinput > :nth-child(2)[class^=highlight],
div.nboutput > :nth-child(2),
div.nboutput > :nth-child(2)[class^=highlight] {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}

/* input area */
div.nbinput > :nth-child(2)[class^=highlight] {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput  > :nth-child(2).stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style>
<div class="section" id="Demonstration-of-SHyFT-API-implementation-of-Kalman-Filtering-on-gridded-data">
<h1>Demonstration of SHyFT API implementation of Kalman Filtering on gridded data<a class="headerlink" href="#Demonstration-of-SHyFT-API-implementation-of-Kalman-Filtering-on-gridded-data" title="Permalink to this headline">¶</a></h1>
<div class="section" id="This-notebook-gives-an-example-of-Met.no-data-post-processing-to-correct-temperature-forecasts-based-on-comparison-to-observations.-The-following-steps-are-described:">
<h2>This notebook gives an example of Met.no data post-processing to correct temperature forecasts based on comparison to observations. The following steps are described:<a class="headerlink" href="#This-notebook-gives-an-example-of-Met.no-data-post-processing-to-correct-temperature-forecasts-based-on-comparison-to-observations.-The-following-steps-are-described:" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><strong>Loading required python modules and setting path to SHyFT
installation</strong></li>
</ol>
<p>Setup steps is about creating synthetic data, and backtesting those so
that we have a known forecast that gives a certain response at the four
observation points</p>
<ol class="arabic simple">
<li><strong>Generate synthetic data for temperature observation time-series</strong></li>
<li><strong>Transform observations from set to grid (Kriging)</strong></li>
<li><a href="#id1"><span class="problematic" id="id2">**</span></a>Create 3 forecasts sets for the 1x1 km grid **</li>
</ol>
<p>grid-pp steps is about orchestrating a grid-pp algorithm given our
syntethic data from above</p>
<ol class="arabic simple">
<li><strong>Transform forecasts from grid to observation points (IDW)</strong></li>
<li><strong>Calculate the bias time-series using Kalman filter on the
difference of observation and forecast set at the observation
points</strong></li>
<li><strong>Transform bias from set to grid (Kriging) and apply bias to the
grid forecast</strong></li>
</ol>
<p>Final steps to plot and test the results from the grid-pp steps</p>
<ol class="arabic simple">
<li><strong>Transform corrected forecasts grid to the observation points
(IDW)</strong></li>
<li><strong>Plot the results and bias</strong></li>
</ol>
<div class="section" id="1.-Loading-required-python-modules-and-setting-path-to-SHyFT-installation">
<h3>1. Loading required python modules and setting path to SHyFT installation<a class="headerlink" href="#1.-Loading-required-python-modules-and-setting-path-to-SHyFT-installation" title="Permalink to this headline">¶</a></h3>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># first you should import the third-party python modules which you&#39;ll use later on</span>
<span class="c1"># the first line enables that figures are shown inline, directly in the notebook</span>
<span class="o">%</span><span class="k">pylab</span> inline
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<div class="highlight"><pre>
Populating the interactive namespace from numpy and matplotlib
</pre></div></div>
</div>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># set the path for your shyft build</span>
<span class="c1"># this should point to the directory that is created</span>
<span class="c1"># when you clone shyft, assuming you have built shyft</span>
<span class="c1"># there and not installed it to your system python</span>
<span class="n">shyft_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;../../../shyft&quot;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shyft_path</span><span class="p">)</span>

<span class="c1"># you could achieve the same by setting a PYTHONPATH</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># once the shyft_path is set correctly, you should be able to import shyft modules</span>
<span class="kn">import</span> <span class="nn">shyft</span>
<span class="kn">from</span> <span class="nn">shyft</span> <span class="kn">import</span> <span class="n">shyftdata_dir</span>

<span class="c1"># if you have problems here, it may be related to having your LD_LIBRARY_PATH</span>
<span class="c1"># pointing to the appropriate libboost_python libraries (.so files)</span>
<span class="kn">from</span> <span class="nn">shyft.repository.default_state_repository</span> <span class="kn">import</span> <span class="n">DefaultStateRepository</span>
<span class="kn">from</span> <span class="nn">shyft.orchestration.configuration</span> <span class="kn">import</span> <span class="n">yaml_configs</span>
<span class="kn">from</span> <span class="nn">shyft.orchestration.simulators.config_simulator</span> <span class="kn">import</span> <span class="n">ConfigSimulator</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">Calendar</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">deltahours</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">Timeaxis</span><span class="p">,</span><span class="n">Timeaxis2</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">Timeseries</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">time_shift</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">TemperatureSource</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">TemperatureSourceVector</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">GeoPoint</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">GeoPointVector</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">bayesian_kriging_temperature</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">BTKParameter</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">idw_temperature</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">IDWTemperatureParameter</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">KalmanFilter</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">KalmanState</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">KalmanBiasPredictor</span>
<span class="kn">from</span> <span class="nn">shyft.api</span> <span class="kn">import</span> <span class="n">create_periodic_pattern_ts</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># now you can access the api of shyft with tab completion and help, try this:</span>

<span class="c1">#help(api.GeoPoint) # remove the hashtag and run the cell to print the documentation of the api.GeoPoint class</span>
<span class="c1">#api. # remove the hashtag, set the pointer behind the dot and use</span>
      <span class="c1"># tab completion to see the available attributes of the shyft api</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="setup:-1.-Generate-synthetic-data-for-temperature-observation-time-series">
<h3>setup: 1. Generate synthetic data for temperature observation time-series<a class="headerlink" href="#setup:-1.-Generate-synthetic-data-for-temperature-observation-time-series" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Create time-axis for our syntethic sample</span>
<span class="n">utc</span> <span class="o">=</span> <span class="n">Calendar</span><span class="p">()</span> <span class="c1"># provide conversion and math for utc time-zone</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">utc</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">deltahours</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">3</span> <span class="c1"># 3 days length</span>
<span class="n">ta</span> <span class="o">=</span> <span class="n">Timeaxis</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="n">ta2</span> <span class="o">=</span> <span class="n">Timeaxis2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="c1"># same as ta, but needed for now(we work on aligning them)</span>

<span class="c1"># 1. Create the terrain based geo-points for the 1x1km grid and the observations</span>

<span class="c1"># a. Create the grid, based on a syntethic terrain model</span>
<span class="c1"># specification of 1 x 1 km</span>
<span class="n">grid_1x1</span> <span class="o">=</span> <span class="n">GeoPointVector</span><span class="p">()</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">grid_1x1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GeoPoint</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="n">y</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mi">50</span><span class="p">))</span> <span class="c1"># z from 0 to 1000 m</span>

<span class="c1"># b. Create the observation points, for metered temperature</span>
<span class="c1"># reasonable withing that grid_1x1, and with elevation z</span>
<span class="c1"># that corresponds approximately to the position</span>
<span class="n">obs_points</span> <span class="o">=</span> <span class="n">GeoPointVector</span><span class="p">()</span>
<span class="n">obs_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GeoPoint</span><span class="p">(</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>  <span class="c1"># observation point at the lowest part</span>
<span class="n">obs_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GeoPoint</span><span class="p">(</span><span class="mi">5100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">270</span> <span class="p">))</span> <span class="c1"># halfway out in x-direction @ 270 masl</span>
<span class="n">obs_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GeoPoint</span><span class="p">(</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">5100</span><span class="p">,</span> <span class="mi">250</span><span class="p">))</span> <span class="c1"># halfway out in y-direction @ 250 masl</span>
<span class="n">obs_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">GeoPoint</span><span class="p">(</span><span class="mi">10100</span><span class="p">,</span><span class="mi">10100</span><span class="p">,</span> <span class="mi">1080</span> <span class="p">))</span> <span class="c1"># x-y at max, so @1080 masl</span>

<span class="c1"># 2. Create time-series having a constant temperature of 15 degC</span>
<span class="c1">#    and add them to the syntetic observation set</span>
<span class="c1">#    make sure there is some reality, like temperature gradient etc.</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">Timeseries</span><span class="p">(</span><span class="n">ta2</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>  <span class="c1"># 20 degC at z_t= 0 meter above sea-level</span>
<span class="c1"># assume set temp.gradient to -0.6 degC/100m, and estimate the other values accordingly</span>
<span class="n">tgrad</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.6</span><span class="o">/</span><span class="mf">100.0</span>  <span class="c1"># in our case in units of degC/m</span>
<span class="n">z_t</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># meter above sea-level</span>

<span class="c1"># Create a TemperatureSourceVector to hold the set of observation time-series</span>
<span class="n">constant_bias</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="o">-</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.7</span><span class="p">,</span><span class="o">+</span><span class="mf">1.0</span><span class="p">]</span>
<span class="n">obs_set</span> <span class="o">=</span> <span class="n">TemperatureSourceVector</span><span class="p">()</span>
<span class="n">obs_set_w_bias</span> <span class="o">=</span> <span class="n">TemperatureSourceVector</span><span class="p">()</span>
<span class="k">for</span> <span class="n">geo_point</span><span class="p">,</span><span class="n">bias</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obs_points</span><span class="p">,</span><span class="n">constant_bias</span><span class="p">):</span>
    <span class="n">temp_at_site</span> <span class="o">=</span>  <span class="n">ts</span> <span class="o">+</span> <span class="n">tgrad</span><span class="o">*</span><span class="p">(</span><span class="n">geo_point</span><span class="o">.</span><span class="n">z</span><span class="o">-</span><span class="n">z_t</span><span class="p">)</span>
    <span class="n">obs_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TemperatureSource</span><span class="p">(</span><span class="n">geo_point</span><span class="p">,</span><span class="n">temp_at_site</span><span class="p">))</span>
    <span class="n">obs_set_w_bias</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TemperatureSource</span><span class="p">(</span><span class="n">geo_point</span><span class="p">,</span><span class="n">temp_at_site</span> <span class="o">+</span> <span class="n">bias</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="setup-2.-Transform-observation-with-bias-to-grid-using-kriging">
<h3>setup 2. Transform observation with bias to grid using kriging<a class="headerlink" href="#setup-2.-Transform-observation-with-bias-to-grid-using-kriging" title="Permalink to this headline">¶</a></h3>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Generate the observation grid by kriging the observations out to 1x1km grid</span>
<span class="c1"># first create idw and kriging parameters that we will utilize in the next steps</span>
<span class="c1"># kriging parameters</span>
<span class="n">btk_params</span> <span class="o">=</span> <span class="n">BTKParameter</span><span class="p">()</span>  <span class="c1"># we could tune parameters here if needed</span>
<span class="c1"># idw parameters,somewhat adapted to the fact that we</span>
<span class="c1">#  know we interpolate from a grid, with a lot of neigbours around</span>
<span class="n">idw_params</span> <span class="o">=</span> <span class="n">IDWTemperatureParameter</span><span class="p">()</span> <span class="c1"># here we could tune the paramete if needed</span>
<span class="n">idw_params</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="mf">1000.0</span> <span class="c1"># max at 10 km because we search for max-gradients</span>
<span class="n">idw_params</span><span class="o">.</span><span class="n">max_members</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># for grid, this include all possible close neighbors</span>
<span class="n">idw_params</span><span class="o">.</span><span class="n">gradient_by_equation</span> <span class="o">=</span> <span class="bp">True</span> <span class="c1"># resolve horisontal component out</span>
<span class="c1"># now use kriging for our &#39;syntethic&#39; observations with bias</span>
<span class="n">obs_grid</span> <span class="o">=</span> <span class="n">bayesian_kriging_temperature</span><span class="p">(</span><span class="n">obs_set_w_bias</span><span class="p">,</span><span class="n">grid_1x1</span><span class="p">,</span><span class="n">ta</span><span class="p">,</span><span class="n">btk_params</span><span class="p">)</span>


<span class="c1"># if we idw/btk back to the sites, we should have something that equals the with_bias:</span>
<span class="c1"># we should get close to zero differences in this to-grid-and-back operation</span>
<span class="n">back_test</span> <span class="o">=</span> <span class="n">idw_temperature</span><span class="p">(</span><span class="n">obs_grid</span><span class="p">,</span> <span class="n">obs_points</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">idw_params</span><span class="p">)</span>
<span class="k">for</span> <span class="n">bt</span><span class="p">,</span><span class="n">wb</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">back_test</span><span class="p">,</span><span class="n">obs_set_w_bias</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;IDW Diff {} : {} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">mid_point</span><span class="p">(),</span><span class="nb">abs</span><span class="p">((</span><span class="n">bt</span><span class="o">.</span><span class="n">ts</span><span class="o">-</span><span class="n">wb</span><span class="o">.</span><span class="n">ts</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

<span class="c1">#back_test = bayesian_kriging_temperature(obs_grid, obs_points, ta, btk_params)</span>
<span class="c1">#for bt,wb in zip(back_test,obs_set_w_bias):</span>
<span class="c1">#    print(&quot;BTK Diff {} : {} &quot;.format(bt.mid_point(),abs((bt.ts-wb.ts).values.to_numpy()).max()))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<div class="highlight"><pre>
IDW Diff GeoPoint(100.0,100.0,10.0) : 0.02689547413054072
IDW Diff GeoPoint(5100.0,100.0,270.0) : 0.03278720737048246
IDW Diff GeoPoint(100.0,5100.0,250.0) : 0.05652912605363625
IDW Diff GeoPoint(10100.0,10100.0,1080.0) : 0.004978394986949297
</pre></div></div>
</div>
</div>
<div class="section" id="setup-3.-Create-3-forecasts-sets-for-the-1x1-km-grid">
<h3>setup 3. Create 3 forecasts sets for the 1x1 km grid<a class="headerlink" href="#setup-3.-Create-3-forecasts-sets-for-the-1x1-km-grid" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Create a forecast grid by copying the obs_grid time-series</span>
<span class="c1"># since we know that idw of them to obs_points will give approx.</span>
<span class="c1">#  the obs_set_w_bias time-series</span>
<span class="c1">#  for the simplicity, we assume the same forecast for all 3 days</span>

<span class="n">fc_grid</span> <span class="o">=</span> <span class="n">TemperatureSourceVector</span><span class="p">()</span>
<span class="n">fc_grid_1_day_back</span> <span class="o">=</span> <span class="n">TemperatureSourceVector</span><span class="p">()</span> <span class="c1"># this is previous day</span>
<span class="n">fc_grid_2_day_back</span> <span class="o">=</span> <span class="n">TemperatureSourceVector</span><span class="p">()</span>  <span class="c1"># this is fc two days ago</span>
<span class="n">one_day_back_dt</span> <span class="o">=</span> <span class="n">deltahours</span><span class="p">(</span><span class="o">-</span><span class="mi">24</span><span class="p">)</span>
<span class="n">two_days_back_dt</span> <span class="o">=</span> <span class="n">deltahours</span><span class="p">(</span><span class="o">-</span><span class="mi">24</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">noise_bias</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_grid</span><span class="p">))]</span> <span class="c1"># we could generate white noise ts into these to test kalman</span>
<span class="k">for</span> <span class="n">fc</span><span class="p">,</span><span class="n">bias</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obs_grid</span><span class="p">,</span><span class="n">noise_bias</span><span class="p">):</span>
    <span class="n">fc_grid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TemperatureSource</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">mid_point</span><span class="p">(),</span><span class="n">fc</span><span class="o">.</span><span class="n">ts</span> <span class="o">+</span> <span class="n">bias</span> <span class="p">))</span>
    <span class="n">fc_grid_1_day_back</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">TemperatureSource</span><span class="p">(</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">mid_point</span><span class="p">(),</span>
                <span class="n">time_shift</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">ts</span> <span class="o">+</span> <span class="n">bias</span><span class="p">,</span> <span class="n">one_day_back_dt</span><span class="p">)</span> <span class="c1">#time-shift the signal back</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="n">fc_grid_2_day_back</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">TemperatureSource</span><span class="p">(</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">mid_point</span><span class="p">(),</span>
                <span class="n">time_shift</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">ts</span> <span class="o">+</span> <span class="n">bias</span><span class="p">,</span> <span class="n">two_days_back_dt</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

<span class="n">grid_forecasts</span> <span class="o">=</span> <span class="p">[</span><span class="n">fc_grid_2_day_back</span><span class="p">,</span> <span class="n">fc_grid_1_day_back</span><span class="p">,</span> <span class="n">fc_grid</span> <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="grid-pp:-1.-Transform-forecasts-from-grid-to-observation-points-(IDW)">
<h3>grid-pp: 1. Transform forecasts from grid to observation points (IDW)<a class="headerlink" href="#grid-pp:-1.-Transform-forecasts-from-grid-to-observation-points-(IDW)" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Now we have 3 simulated forecasts at a 1x1 km grid</span>
<span class="c1"># fc_grid, fc_grid_1_day_back, fc_grid_2_day_back</span>
<span class="c1"># we start to do the grid pp algorithm stuff</span>
<span class="c1"># - we know the our forecasts have some degC. bias, and we would hope that</span>
<span class="c1">#   the kalman filter &#39;learns&#39; the offset</span>
<span class="c1"># as a first step we project the grid_forecasts to the observation points</span>
<span class="c1"># making a list of historical forecasts at each observation point.</span>

<span class="n">fc_at_observation_points</span> <span class="o">=</span> <span class="p">[</span><span class="n">idw_temperature</span><span class="p">(</span><span class="n">fc</span><span class="p">,</span> <span class="n">obs_points</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">idw_params</span><span class="p">)</span>\
                            <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">grid_forecasts</span><span class="p">]</span>
<span class="n">historical_forecasts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_points</span><span class="p">)):</span>  <span class="c1"># correlate obs.point and fc using common i</span>
    <span class="n">fc_list</span> <span class="o">=</span> <span class="n">TemperatureSourceVector</span><span class="p">()</span>  <span class="c1"># the kalman bias predictor below accepts TsVector of forecasts</span>
    <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">fc_at_observation_points</span><span class="p">:</span>
        <span class="n">fc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># pick out the fc_ts only, for the i&#39;th observation point</span>
        <span class="c1">#print(&quot;{} adding fc pt {} t0={}&quot;.format(i,fc[i].mid_point(),utc.to_string(fc[i].ts.time(0))))</span>
    <span class="n">historical_forecasts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fc_list</span><span class="p">)</span>
<span class="c1"># historical_forecasts  now cntains 3 forecasts for each observation point</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="grid-pp:-2.-Calculate-the-bias-time-series-using-Kalman-filter-on-the-observation-set">
<h3>grid-pp: 2. Calculate the bias time-series using Kalman filter on the observation set<a class="headerlink" href="#grid-pp:-2.-Calculate-the-bias-time-series-using-Kalman-filter-on-the-observation-set" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Create a TemperatureSourceVector to hold the set of bias time-series</span>
<span class="n">bias_set</span> <span class="o">=</span> <span class="n">TemperatureSourceVector</span><span class="p">()</span>

<span class="c1"># Create the Kalman filter having 8 samples spaced every 3 hours to represent a daily periodic pattern</span>

<span class="n">kalman_dt_hours</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">kalman_dt</span> <span class="o">=</span><span class="n">deltahours</span><span class="p">(</span><span class="n">kalman_dt_hours</span><span class="p">)</span>
<span class="n">kta</span> <span class="o">=</span> <span class="n">Timeaxis2</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">kalman_dt</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">24</span><span class="o">//</span><span class="n">kalman_dt_hours</span><span class="p">))</span>

<span class="c1"># Calculate the coefficients of Kalman filter and</span>
<span class="c1"># Create bias time-series based on the daily periodic pattern</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_set</span><span class="p">)):</span>
    <span class="n">kf</span> <span class="o">=</span> <span class="n">KalmanFilter</span><span class="p">()</span> <span class="c1"># each observation location do have it&#39;s own kf &amp;predictor</span>
    <span class="n">kbp</span> <span class="o">=</span> <span class="n">KalmanBiasPredictor</span><span class="p">(</span><span class="n">kf</span><span class="p">)</span>
    <span class="c1">#print(&quot;Diffs for obs&quot;, i)</span>
    <span class="c1">#for fc in historical_forecasts[i]:</span>
    <span class="c1">#    print((fc.ts-obs_set[i].ts).values.to_numpy())</span>
    <span class="n">kbp</span><span class="o">.</span><span class="n">update_with_forecast</span><span class="p">(</span><span class="n">historical_forecasts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">obs_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span><span class="p">,</span> <span class="n">kta</span><span class="p">)</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">KalmanState</span><span class="o">.</span><span class="n">get_x</span><span class="p">(</span><span class="n">kbp</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
    <span class="c1">#print(pattern)</span>
    <span class="n">bias_ts</span> <span class="o">=</span> <span class="n">create_periodic_pattern_ts</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">kalman_dt</span><span class="p">,</span> <span class="n">ta</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ta2</span><span class="p">)</span>
    <span class="n">bias_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TemperatureSource</span><span class="p">(</span><span class="n">obs_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mid_point</span><span class="p">(),</span> <span class="n">bias_ts</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="grid-pp:-3.-Spread-the-bias-at-observation-points-out-to-the-grid-using-kriging">
<h3>grid-pp: 3. Spread the bias at observation points out to the grid using kriging<a class="headerlink" href="#grid-pp:-3.-Spread-the-bias-at-observation-points-out-to-the-grid-using-kriging" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Generate the bias grid by kriging the bias out on the 1x1km grid</span>
<span class="n">btk_params</span> <span class="o">=</span> <span class="n">BTKParameter</span><span class="p">()</span>
<span class="n">btk_bias_params</span> <span class="o">=</span> <span class="n">BTKParameter</span><span class="p">(</span><span class="n">temperature_gradient</span><span class="o">=-</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">temperature_gradient_sd</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">sill</span><span class="o">=</span><span class="mf">25.0</span><span class="p">,</span> <span class="n">nugget</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="mf">5000.0</span><span class="p">,</span> <span class="n">zscale</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>
<span class="n">bias_grid</span> <span class="o">=</span>  <span class="n">bayesian_kriging_temperature</span><span class="p">(</span><span class="n">bias_set</span><span class="p">,</span> <span class="n">grid_1x1</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">btk_bias_params</span><span class="p">)</span>
<span class="c1"># Correct forecasts by applying bias time-series on the grid</span>
<span class="n">fc_grid_improved</span> <span class="o">=</span> <span class="n">TemperatureSourceVector</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fc_grid</span><span class="p">)):</span>
    <span class="n">fc_grid_improved</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">TemperatureSource</span><span class="p">(</span>
            <span class="n">fc_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mid_point</span><span class="p">(),</span>
            <span class="n">fc_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span> <span class="o">-</span> <span class="n">bias_grid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span> <span class="c1"># By convention, sub bias time-series(hmm..)</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Check the first value of the time-series. It should be around 15</span>
<span class="n">tx</span> <span class="o">=</span><span class="n">ta</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Comparison original synthetic grid cell [0]</span><span class="se">\n\t</span><span class="s2"> at the lower left corner,</span><span class="se">\n\t</span><span class="s2"> at t {}</span><span class="se">\n\t</span><span class="s2">original grid: {}</span><span class="se">\n\t</span><span class="s2">improved grid: {}</span><span class="se">\n\t</span><span class="s2"> vs bias grid: {}</span><span class="se">\n\t</span><span class="s2"> nearest obs: {}&quot;</span>
      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utc</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span>
              <span class="n">fc_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span>
              <span class="n">fc_grid_improved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span>
              <span class="n">bias_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span>
              <span class="n">obs_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
             <span class="p">)</span>
      <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<div class="highlight"><pre>
Comparison original synthetic grid cell [0]
         at the lower left corner,
         at t 2016-01-01T00:00:00Z
        original grid: 18.985602994492123
        improved grid: 19.861755931104128
         vs bias grid: -0.8761529366120062
         nearest obs: 19.94
</pre></div></div>
</div>
</div>
<div class="section" id="Presentation&amp;Test:-8.-Finally,-Transform-corrected-forecasts-from-grid-to-observation-points-to-see-if-we-did-reach-the-goal-of-adjusting-the-forecast-(IDW)">
<h3>Presentation&amp;Test: 8. Finally, Transform corrected forecasts from grid to observation points to see if we did reach the goal of adjusting the forecast (IDW)<a class="headerlink" href="#Presentation&Test:-8.-Finally,-Transform-corrected-forecasts-from-grid-to-observation-points-to-see-if-we-did-reach-the-goal-of-adjusting-the-forecast-(IDW)" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Generate the corrected forecast set by Krieging transform of temperature model</span>
<span class="n">fc_at_observations_improved</span> <span class="o">=</span> <span class="n">idw_temperature</span><span class="p">(</span><span class="n">fc_grid_improved</span><span class="p">,</span> <span class="n">obs_points</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">idw_params</span><span class="p">)</span>
<span class="n">fc_at_observations_raw</span> <span class="o">=</span><span class="n">idw_temperature</span><span class="p">(</span><span class="n">fc_grid</span><span class="p">,</span> <span class="n">obs_points</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">idw_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="9.-Plot-the-results">
<h3>9. Plot the results<a class="headerlink" href="#9.-Plot-the-results" title="Permalink to this headline">¶</a></h3>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Make a time-series plot of temperature sets</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bias_set</span><span class="p">)):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">obs_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">time_axis</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">obs_set</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Observation&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">fc_at_observations_improved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Forecast improved&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="n">fc_at_observations_raw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Forecast (raw)&#39;</span><span class="p">)</span>
    <span class="c1">#ax.plot(timestamps, bias_set[i].ts.values, label = str(i+1) + &#39; Bias&#39;)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Temperature&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Temp ($^\circ$C)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput container">
<div class="container">
</div>
<div class="container">
<img alt="../../_images/notebooks_grid-pp_gridpp_geopoints_22_0.png" src="../../_images/notebooks_grid-pp_gridpp_geopoints_22_0.png" />
</div>
</div>
<div class="nboutput container">
<div class="container">
</div>
<div class="container">
<img alt="../../_images/notebooks_grid-pp_gridpp_geopoints_22_1.png" src="../../_images/notebooks_grid-pp_gridpp_geopoints_22_1.png" />
</div>
</div>
<div class="nboutput container">
<div class="container">
</div>
<div class="container">
<img alt="../../_images/notebooks_grid-pp_gridpp_geopoints_22_2.png" src="../../_images/notebooks_grid-pp_gridpp_geopoints_22_2.png" />
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<img alt="../../_images/notebooks_grid-pp_gridpp_geopoints_22_3.png" src="../../_images/notebooks_grid-pp_gridpp_geopoints_22_3.png" />
</div>
</div>
<div class="nbinput container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># Make a scatter plot of grid temperature forecasts at ts.value(0)</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">fc</span><span class="o">.</span><span class="n">mid_point</span><span class="p">()</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">bias_grid</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">fc</span><span class="o">.</span><span class="n">mid_point</span><span class="p">()</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">fc</span> <span class="ow">in</span> <span class="n">bias_grid</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">temps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">bias</span><span class="o">.</span><span class="n">ts</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">bias</span> <span class="ow">in</span> <span class="n">bias_grid</span><span class="p">])</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">temps</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Temp bias correction ($^\circ$C)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast container">
<div class="container">
</div>
<div class="container">
<img alt="../../_images/notebooks_grid-pp_gridpp_geopoints_23_0.png" src="../../_images/notebooks_grid-pp_gridpp_geopoints_23_0.png" />
</div>
</div>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
<div class="nbinput nblast container">
<div class="highlight-none"><div class="highlight"><pre>
<span></span>In [ ]:
</pre></div>
</div>
<div class="highlight-ipython3"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Demonstration of SHyFT API implementation of Kalman Filtering on gridded data</a><ul>
<li><a class="reference internal" href="#This-notebook-gives-an-example-of-Met.no-data-post-processing-to-correct-temperature-forecasts-based-on-comparison-to-observations.-The-following-steps-are-described:">This notebook gives an example of Met.no data post-processing to correct temperature forecasts based on comparison to observations. The following steps are described:</a><ul>
<li><a class="reference internal" href="#1.-Loading-required-python-modules-and-setting-path-to-SHyFT-installation">1. Loading required python modules and setting path to SHyFT installation</a></li>
<li><a class="reference internal" href="#setup:-1.-Generate-synthetic-data-for-temperature-observation-time-series">setup: 1. Generate synthetic data for temperature observation time-series</a></li>
<li><a class="reference internal" href="#setup-2.-Transform-observation-with-bias-to-grid-using-kriging">setup 2. Transform observation with bias to grid using kriging</a></li>
<li><a class="reference internal" href="#setup-3.-Create-3-forecasts-sets-for-the-1x1-km-grid">setup 3. Create 3 forecasts sets for the 1x1 km grid</a></li>
<li><a class="reference internal" href="#grid-pp:-1.-Transform-forecasts-from-grid-to-observation-points-(IDW)">grid-pp: 1. Transform forecasts from grid to observation points (IDW)</a></li>
<li><a class="reference internal" href="#grid-pp:-2.-Calculate-the-bias-time-series-using-Kalman-filter-on-the-observation-set">grid-pp: 2. Calculate the bias time-series using Kalman filter on the observation set</a></li>
<li><a class="reference internal" href="#grid-pp:-3.-Spread-the-bias-at-observation-points-out-to-the-grid-using-kriging">grid-pp: 3. Spread the bias at observation points out to the grid using kriging</a></li>
<li><a class="reference internal" href="#Presentation&amp;Test:-8.-Finally,-Transform-corrected-forecasts-from-grid-to-observation-points-to-see-if-we-did-reach-the-goal-of-adjusting-the-forecast-(IDW)">Presentation&amp;Test: 8. Finally, Transform corrected forecasts from grid to observation points to see if we did reach the goal of adjusting the forecast (IDW)</a></li>
<li><a class="reference internal" href="#9.-Plot-the-results">9. Plot the results</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../nea-example/calibrate_nea_nidelva.html"
                        title="previous chapter">Running a calibration with SHyFT</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="gridpp_simple.html"
                        title="next chapter">Demonstration of SHyFT API implementation of Kalman Filtering on time series</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/notebooks/grid-pp/gridpp_geopoints.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="gridpp_simple.html" title="Demonstration of SHyFT API implementation of Kalman Filtering on time series"
             >next</a> |</li>
        <li class="right" >
          <a href="../nea-example/calibrate_nea_nidelva.html" title="Running a calibration with SHyFT"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Shyft 0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../introduction.html" >What&#8217;s SHyFT?</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../../notebook.html" >Notebooks</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Sigbjørn Helset, Ola Skavhaug, John F. Burkhart.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.8.
    </div>
  </body>
</html>